# This workflow validates and then deploys our Terraform code.
name: deploy
run-name: ${{ github.workflow }}
on:
  push:
    branches:
      - main
    paths:
      - terraform/**
  pull_request:
    branches:
      - main
    paths:
      - terraform/**
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        description: "Specify the environment to deploy into"

# Cancel in progress workflows regardless of the trigger.
# The newly triggered workflow is going to fail by default because another deployment has the Terraform lock,
# so we override this and always deploy the most recently triggered workflow.
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  id-token: write
  security-events: write
  pull-requests: write

env:
  TERRAFORM_ENV_DIR: ${{ github.workspace }}/terraform/environments

jobs:
  select-environment:
    name: select-environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.select-environment.outputs.environment || inputs.environment }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: actions/checkout@v3

      - name: Find which environment/s changed
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            modules:
              - '**/modules/**'
            development:
              - '**/development/**'
            staging:
              - '**/staging/**'
            production:
              - '**/production/**'

      # Deployments to multiple environments simultaneously is not allowed.
      # The deployment priority is as follows:
      # 1. Changes to module      files  ->  deploy to development to test it out
      # 1. Changes to production  files  ->  deploy to production
      # 2. Changes to staging     files  ->  deploy to staging
      # 3. Changes to development files  ->  deploy to development
      - name: Select deployment environment
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        id: select-environment
        run: |
          environment=""
          if [ "${{ steps.filter.outputs.modules }}" == "true" ]; then
            environment="development"
          elif [ "${{ steps.filter.outputs.production }}" == "true" ]; then
            environment="production"
          elif [ "${{ steps.filter.outputs.staging }}" == "true" ]; then
            environment="staging"
          elif [ "${{ steps.filter.outputs.development }}" == "true" ]; then
            environment="development"
          else
            echo "Error finding changes to terraform files"
            exit 1
          fi
          echo "Selected the $environment environment" 
          echo "environment=$environment" >> $GITHUB_OUTPUT

  deploy:
    name: deploy
    needs: select-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.select-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.select-environment.outputs.environment }}
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.TERRAFORM_ENV_DIR }}/${{ env.ENVIRONMENT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run tfsec
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          working_directory: ${{ env.TERRAFORM_ENV_DIR }}/${{ env.ENVIRONMENT }}
          sarif_file: tfsec.sarif
          tfvars_file: ${{ env.TERRAFORM_ENV_DIR }}/${{ env.ENVIRONMENT }}/${{ env.ENVIRONMENT }}.auto.tfvars

      # TODO: Uncomment when repo is public
      # - name: Upload SARIF file
      #   uses: github/codeql-action/upload-sarif@v2
      #   with:
      #     sarif_file: ${{ env.TERRAFORM_ENV_DIR }}/tfsec.sarif # path to SARIF file relative to the root of the repository
      #     category: tfsec

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check

      - name: Terraform init
        run: terraform init

      - name: Terraform validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform plan
        if: github.event_name == 'pull_request'
        id: plan
        run: |
          terraform plan \
            -var="client_id=${{ secrets.CLIENT_ID }}" \
            -var="tenant_id=${{ secrets.TENANT_ID }}" \
            -var="subscription_id=${{ secrets.SUBSCRIPTION_ID }}"
        continue-on-error: true

      - name: Update pull request
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`\n
            ${process.env.PLAN}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform plan status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform apply
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        id: apply
        run: |
          terraform apply -no-color -auto-approve \
            -var="client_id=${{ secrets.CLIENT_ID }}" \
            -var="tenant_id=${{ secrets.TENANT_ID }}" \
            -var="subscription_id=${{ secrets.SUBSCRIPTION_ID }}"
