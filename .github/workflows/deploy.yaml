# This workflow validates our Terraform modules, selects our deployment's environment, and then deploys our Terraform code.
name: deploy
run-name: ${{ github.workflow }}
on:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - terraform/environments/**
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     - terraform/environments/**
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        required: true
        description: "Specify the deployment's environment"
      tf_apply:
        type: boolean
        default: true
        required: true
        description: "Run `terraform apply`"

concurrency:
  group: validate-deploy-workflows
  cancel-in-progress: false

permissions:
  actions: read
  contents: read
  id-token: write
  security-events: write
  pull-requests: write

env:
  TERRAFORM_ENV_DIR: ${{ github.workspace }}/terraform/environments

jobs:
  validate-modules:
    name: validate-modules-workflow-status
    runs-on: ubuntu-latest
    steps:
      - name: Validate workflow status
        uses: LASER-Yi/workflow-status@v0.1.0
        id: validate-modules-workflow-status
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: validate_modules.yaml
          branch: main

      - name: Check workflow status
        if: steps.validate-modules-workflow-status.conclusion == 'failure'
        run: |
          echo "Latest run of validate-modules was a failure"
          exit 1

  select-environment:
    name: select-environment
    needs: validate-modules
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.select-environment.outputs.environment || inputs.environment }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: actions/checkout@v3

      - name: Find which environment/s changed
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            development:
              - '**/development/**'
            staging:
              - '**/staging/**'
            production:
              - '**/production/**'

      # Deployments to multiple environments simultaneously is not allowed.
      # The deployment priority is as follows:
      # 1. Changes to production  files  ->  deploy to production
      # 2. Changes to staging     files  ->  deploy to staging
      # 3. Changes to development files  ->  deploy to development
      - name: Select deployment environment
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        id: select-environment
        run: |
          environment=""
          if [ "${{ steps.filter.outputs.production }}" == "true" ]; then
            environment="production"
          elif [ "${{ steps.filter.outputs.staging }}" == "true" ]; then
            environment="staging"
          elif [ "${{ steps.filter.outputs.development }}" == "true" ]; then
            environment="development"
          else
            echo "Error finding changes to terraform files"
            exit 1
          fi
          echo "Selected the $environment environment" 
          echo "environment=$environment" >> $GITHUB_OUTPUT

  deploy:
    name: deploy
    needs: select-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.select-environment.outputs.environment }}

    # Cancel in progress jobs/workflows that have the same environment
    concurrency:
      group: ${{ github.workflow }}-${{ needs.select-environment.outputs.environment }}
      cancel-in-progress: true

    env:
      ENVIRONMENT: ${{ needs.select-environment.outputs.environment }}
      REPORTS_DIR: ${{ github.workspace }}/terraform/environments/${{ needs.select-environment.outputs.environment }}/reports
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.TERRAFORM_ENV_DIR }}/${{ env.ENVIRONMENT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        id: tfsec
        with:
          working_directory: ${{ env.TERRAFORM_ENV_DIR }}/${{ env.ENVIRONMENT }}
          soft_fail: false
          additional_args: "--tfvars-file ${{ env.ENVIRONMENT }}.auto.tfvars --concise-output"
          github_token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform init
        id: init
        run: terraform init
        continue-on-error: true

      - name: Terraform validate
        id: validate
        run: terraform validate -no-color
        continue-on-error: true

      - name: Terraform plan
        id: plan
        run: |
          terraform plan -out=${{ env.ENVIRONMENT }}.tf \
            -var="client_id=${{ secrets.CLIENT_ID }}" \
            -var="tenant_id=${{ secrets.TENANT_ID }}" \
            -var="subscription_id=${{ secrets.SUBSCRIPTION_ID }}"
        continue-on-error: true

      - name: Update pull request
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Tfsec Scan Result „äôÔ∏è\`${{ steps.tfsec.outcome }}\`
            #### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            <details><summary>Validation Output</summary>

            \`\`\`\n
            ${{ steps.validate.outputs.stdout }}
            \`\`\`

            </details>

            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`\n
            ${process.env.PLAN}
            \`\`\`

            </details>

            *Actor: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Working Directory: \`${{ env.TERRAFORM_ENV_DIR }}/${{ env.ENVIRONMENT }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Check tfsec status
        if: steps.tfsec.outcome == 'failure'
        run: exit 1

      - name: Check terraform status
        if: steps.fmt.outcome == 'failure' || steps.init.outcome == 'failure' || steps.validate.outcome == 'failure'
        run: exit 1

      - name: Terraform apply
        if: inputs.tf_apply || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        id: apply
        run: |
          terraform apply ${{ env.ENVIRONMENT }}.tf \
            -no-color -auto-approve \
            -var="client_id=${{ secrets.CLIENT_ID }}" \
            -var="tenant_id=${{ secrets.TENANT_ID }}" \
            -var="subscription_id=${{ secrets.SUBSCRIPTION_ID }}"
